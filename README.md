# Keenetic FQDN Policy-Based Routing

В Keenetic OS 5.0 была добавлена абсолютна схожая по принципу функция маршрутизации на основе доменных имен:
`Добавлена новая вкладка Маршруты DNS на странице Статические маршруты, на которой можно создавать собственные правила маршрутизации через указанное соединение или шлюз для определенных пользователем списков доменных имен и IP-адресов. [NWI-4186]`. В связи с этим проект уходит в архив.

## Замечания

- Этот код создан для изучения сетевых технологий. Он может быть полезен для улучшения работы интернета, но то, как вы его используете — ваш выбор.
  Автор ответственности не несет.

- Статическая маршрутизация на основе FQDN PBR требует времени для сбора IP-адресов доменов.
  В начале возможна нестабильность — просто обновите страницу пару раз что бы собрались возможные IP-адреса домена.

## Требования

- [Keenetic OS](https://help.keenetic.com/hc/ru/articles/115000990005) версии 4.0 или выше.
- Установленный [Entware](https://help.keenetic.com/hc/ru/articles/360021214160).

## Шаги установки

### 1. Настройки в веб-панели Keenetic

- Купите, настройте и включите туннель [VPN](https://help.keenetic.com/hc/ru/articles/115005342025)
  или [Proxy](https://help.keenetic.com/hc/ru/articles/7474374790300).

- Отключите [DNS от провайдера](https://help.keenetic.com/hc/ru/articles/360008609399) и настройте [DNS-over-HTTPS](https://help.keenetic.com/hc/ru/articles/360007687159), например от CloudFlare: `https://cloudflare-dns.com/dns-query`.

### 2. Установка

- Скачайте [файл релиза](https://github.com/GuFFy12/keenetic-fqdn-pbr/releases) формата `.ipk` прямо на роутере. Также можно скачать файл локально и переместить его через [Менеджер USB-устройств](https://help.keenetic.com/hc/en-us/articles/360000799559).

- Установите пакет командой: `opkg install --force-maintainer <ИМЯ_ФАЙЛА>`.

- Если вы ранее не использовали dnsmasq, рекомендуется установить пакет с опцией `--force-maintainer`. В этом случае конфигурационный файл dnsmasq.conf будет сразу перезаписан стандартной версией из пакета. Если не указать этот флаг, opkg не станет трогать ваш существующий dnsmasq.conf, а новый файл будет сохранён рядом под именем dnsmasq.conf-opkg.

### 3. Продолжение настройки в веб-панели Keenetic

- Создайте записи DNS на адресе `192.168.1.1:5300` для доменов, к которым нужен доступ через туннель.
- Пример списка доменов:

  ```plaintext
  chatgpt.com
  openai.com
  oaiusercontent.com
  github.com
  githubusercontent.com
  githubcopilot.com
  ```

### 4. Конфигурация Dnsmasq ([`/opt/etc/dnsmasq.conf`](https://thekelleys.org.uk/dnsmasq/docs/dnsmasq-man.html))

- Переменная `server` необходимо установить на DoH, который используется для получения DNS записей.
  Чтобы получить список DNS серверов, выполните следующую команду:

  ```sh
  cat /tmp/ndnproxymain.stat
  ```

### 5. Конфигурация FQDN PBR (`/opt/fqdn-pbr/dnsmasq_routing.conf`)

- Устройство отправляет DNS-запрос на маршрутизатор, который с помощью Dnsmasq возвращает IP-адрес и добавляет его в ipset.
  Все IP-адреса из ipset перенаправляются через туннель. Для работы системы важно, чтобы все DNS-запросы шли через маршрутизатор.

- Переменную `INTERFACE_LAN_SUBNETS` необходимо установить на сети которые вы хотите обрабатывать. Можно указать IP/32 что бы обрабатывать конкретный IP.
  Чтобы узнать диапазоны сетей, выполните команду:

  ```sh
  ip route
  ```

- Переменную `INTERFACE_WAN` необходимо установить на интерфейс тунеля.
  Чтобы получить список интерфейсов выполните следующую команду:

  ```sh
  ip -o -4 addr show
  ```

- Опционально настройте следующие переменные:
  - `KILL_SWITCH` - если установлено в `1`, при отключении VPN или прокси трафик не будет направляться в сеть.
  - `IPSET_TABLE_SAVE` - если установлено в `1`, таблица с IP-адресами будет сохранена при перезагрузке.
  - `IPSET_TABLE` - имя таблицы ipset.
  - `IPSET_TABLE_TIMEOUT` - тайм-аут для записей в таблице (`0` для неограниченного времени).
  - `MARK` - маркер, используемый в iptables.

- Для запуска используйте команды: `/opt/etc/init.d/S56dnsmasq start` и `/opt/etc/init.d/S52fqdn-pbr start`.
